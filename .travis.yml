language: python
dist: bionic
addons:
  apt:
    packages:
      - libboost-dev libboost-system-dev
      - qtbase5-dev libqt5svg5-dev
  coverity_scan:
    project:
      name: "rmartin16/qbittorrent-api"
      description: "Python client implementation for qBittorrent's Web API"
    notification_email: rmartin16@gmail.com
    build_command_prepend: echo
    build_command: echo
    branch_pattern: coverity_scan
python:
  #- 2.7
  #- 3.4  # not supported on bionic
  #- 3.5
  #- 3.6
  #- 3.7
  - 3.8
  #- 3.9-dev
  #- 3.10-dev
  - pypy3
env:
  - global:
      - secure: "Oswps/VybIB0Kmm9tQr4EgqUtlKVr4ns2RMCwRYmlkD442gm9AxJxm2NeOxAkLOFSECWHwYaw5nCflW5fl+qXx7OPJA7XcLiWLJ56emuV1EaO6/ixPhDESPAyiN+v7FCOtgVtR4j7QrjzM6ExYGjs9+JmGKprErns10krRF90FbIvSGCsSmoZaGgwxd9uN+t4jlZmPbDbgqXrKhn0kk+WJguad2bdPzsjzj610ATKxcusMimak7WR1w1vi4cqkDyfjBCc+80SfZVpMrCb8uftt7ikfLKnrmIIhcPJ8JqEGr6Tp74z5W8bxuCeYTwIJwirvrHb4j/S+bf48aSUBwlra1tjRDq558GhL2VGovlVmNMZgXmqZo+K6jTUSBZX20xp7YGEF4aiFeetkeaDr8h7nav+2HnjMb5elgHs+G0TVQ3zyxc3vmxN+1oACmQVi3QxsqhPQUFoPRfjw7NqNpz2HMmOozXmPABviyhgHjsjGRKiIs3kyRJssglKo0hNOvZ540g8WuxaFPXgYStHNOuZynZPGWMd/0MZxfbdeh+AVwAG2Lxp3Hq77XhIm9GkbLFg9ybvBPCKHE2DrXT1fbKozzF7Y8V3bzOlbvexIowp2s8ojmliWShRvBndJjlDEKhmloOSobpM3lPImiz+jXM5E5jKGUOas4ECjShYBYZXBM="
  - QBT_VER="4.1.0"
  - QBT_VER="4.1.1"
  #- QBT_VER="4.1.2"  # nox version wouldn't start out of the box: fixed in https://github.com/qbittorrent/qBittorrent/pull/9365
  - QBT_VER="4.1.3"
  - QBT_VER="4.1.4"
  - QBT_VER="4.1.5"
  - QBT_VER="4.1.6"
  - QBT_VER="4.1.7"
  - QBT_VER="4.1.8"
  - QBT_VER="4.1.9"
  - QBT_VER="4.1.9.1"
  - QBT_VER="4.2.0"
  - QBT_VER="4.2.1"
  - QBT_VER="4.2.2"
  - QBT_VER="4.2.3"
  - QBT_VER="4.2.4"
  - QBT_VER="4.2.5"
jobs:
  allow_failures:
    - python: pypy3
    - python: 3.9-dev
    - python: 3.10-dev
cache:
  directories:
    - $HOME/deb  # until deb downloads are more reliable...
    - $HOME/.cache/pip
before_install:
  - python --version
  - pip install -U pip
  - pip install -U pytest
  - pip install -U pytest-cov
  - pip install codecov
  # prepare to install qbittorrent things
  - mkdir -p $HOME/deb
  - mkdir -p $HOME/Downloads  # default torrent download location
  - alias wget="wget --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 100"
  # install libtorrent-rasterbar
  - if [ ! -f $HOME/deb/libtorrent-rasterbar9_amd64.deb ]; then wget https://bit.ly/libtorrent-rasterbar9-1-1-1 -O $HOME/deb/libtorrent-rasterbar9_amd64.deb; fi
  - if [ ! -f $HOME/deb/libtorrent-rasterbar-dev_amd64.deb ]; then wget https://bit.ly/libtorrent-rasterbar-dev-1-1-1 -O $HOME/deb/libtorrent-rasterbar-dev_amd64.deb; fi
  - sudo dpkg -i $HOME/deb/libtorrent-rasterbar-dev_amd64.deb $HOME/deb/libtorrent-rasterbar9_amd64.deb
  # install qBittorrent
  - if [ ! -f $HOME/deb/qbittorrent_nox_amd64.deb ]; then wget https://bit.ly/qbittorrent-nox-amd64-$(echo "$QBT_VER" | tr . -) -O $HOME/deb/qbittorrent_nox_amd64.deb; fi
  - sudo dpkg -i $HOME/deb/qbittorrent_nox_amd64.deb
  # start qBittorrent
  - $QBT_PATH/bin/qbittorrent-nox --daemon
install:
  - pip install .
script: pytest
after_success:
  - codecov
